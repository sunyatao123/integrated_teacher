<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§ä½“æµ‹æ•°æ®ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 32px;
        }

        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .class-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .class-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .class-card:hover {
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .class-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .class-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .class-card button {
            background: #dc3545;
            padding: 8px 16px;
            font-size: 14px;
            margin-top: 10px;
        }

        .class-card .btn-download {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-right: 10px;
        }

        .class-card-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .class-card-details.show {
            display: block;
        }

        .student-group-detail {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .student-group-detail h4 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .student-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .student-tag {
            background: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: #333;
            border: 1px solid #ddd;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .result-card h3 {
            margin-bottom: 15px;
            font-size: 20px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .result-item strong {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .weakness-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            margin: 4px;
            font-weight: 600;
        }

        .progress-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            color: #555;
            border: 1px solid #e0e0e0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.3s;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-header">
            <h1>ğŸ“Š ç­çº§ä½“æµ‹æ•°æ®ç®¡ç†ç³»ç»Ÿ</h1>
            <a href="/" class="nav-link" onclick="sessionStorage.setItem('returnFromClassManager', 'true')">â† è¿”å›ä¸»é¡µ</a>
        </div>

        <div id="message" class="message"></div>

        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="section" style="background:#e8f4fd; border-left:4px solid #2196F3;">
            <h2 style="color:#2196F3;">ğŸ’¡ ç³»ç»ŸåŠŸèƒ½</h2>
            <ul style="margin:10px 0; padding-left:20px; color:#555; line-height:1.8;">
                <li>ğŸ“¤ <strong>æ™ºèƒ½åˆ†æ</strong>ï¼šä¸Šä¼ ä½“æµ‹æ•°æ®ï¼ŒAIè‡ªåŠ¨åˆ†æè–„å¼±é¡¹</li>
                <li>ğŸ¯ <strong>å…­å¤§ç»´åº¦</strong>ï¼šå½¢æ€ã€è€åŠ›ã€åŠ›é‡ã€æŸ”éŸ§ã€é€Ÿåº¦ã€æœºèƒ½</li>
                <li>ğŸ’¾ <strong>è‡ªåŠ¨ä¿å­˜</strong>ï¼šåˆ†æç»“æœè‡ªåŠ¨å­˜å‚¨ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ</li>
                <li>ğŸ¤– <strong>æ™ºèƒ½è¯†åˆ«</strong>ï¼šé—®ç­”æ—¶è‡ªåŠ¨è¯†åˆ«ç­çº§ï¼Œæ— éœ€é‡å¤è¾“å…¥</li>
            </ul>
        </div>

        <!-- ä¸Šä¼ ä½“æµ‹æ•°æ® -->
        <div class="section">
            <h2>ğŸ“¤ ä¸Šä¼ ä½“æµ‹æ•°æ®</h2>
            <div class="upload-area">
                <form id="uploadForm">
                    <div class="form-group">
                        <label for="fileInput">
                            <span style="color:#667eea;">â—</span> ä½“æµ‹æ•°æ®æ–‡ä»¶
                        </label>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" required>
                        <small style="color:#999; display:block; margin-top:6px;">
                            ğŸ“‹ æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼ï¼Œé€‰æ‹©æ–‡ä»¶åå°†è‡ªåŠ¨å¡«å……ç­çº§åç§°
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="className">
                            <span style="color:#667eea;">â—</span> ç­çº§åç§°
                        </label>
                        <input type="text" id="className" placeholder="ä¾‹å¦‚ï¼šä¸€å¹´çº§100ç­ã€ä¹å¹´çº§å…«ç­" required>
                        <small style="color:#999; display:block; margin-top:6px;">
                            ğŸ’¡ å·²è‡ªåŠ¨ä»æ–‡ä»¶åæå–ï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹
                        </small>
                    </div>
                    <button type="submit" id="uploadBtn">
                        <span id="uploadBtnText">ğŸš€ å¼€å§‹åˆ†æ</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- åˆ†æç»“æœå’Œè¿›åº¦ -->
        <div id="analysisSection" class="section" style="display:none;">
            <h2>ğŸ” åˆ†æç»“æœ</h2>

            <!-- åˆ†æè¿›åº¦æ—¥å¿— -->
            <div id="progressLog" class="progress-log" style="margin-bottom:20px;">
                <div style="color:#667eea; font-weight:bold; margin-bottom:10px;">ğŸ“Š åˆ†ææ—¥å¿—</div>
            </div>

            <!-- åˆ†æç»“æœå¡ç‰‡ -->
            <div id="resultCard" style="display:none;"></div>
        </div>

        <!-- æ‰¹é‡åˆ†æ -->
        <div class="section" style="background:#f0f4ff;">
            <h2>ğŸ”„ æ‰¹é‡åˆ†æ</h2>
            <p style="margin-bottom: 15px; color:#666; line-height:1.6;">
                é€‰æ‹©åŒ…å«ä½“æµ‹æ•°æ®çš„æ–‡ä»¶å¤¹,è‡ªåŠ¨åˆ†ææ–‡ä»¶å¤¹å†…æ‰€æœ‰Excelæ–‡ä»¶
            </p>
            <div class="form-group">
                <label for="batchFolderInput">
                    <span style="color:#4caf50;">â—</span> é€‰æ‹©ä½“æµ‹æ•°æ®æ–‡ä»¶å¤¹
                </label>
                <input type="file" id="batchFolderInput" webkitdirectory directory multiple>
                <small style="color:#999; display:block; margin-top:6px;">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹å,ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¹¶åˆ†æå…¶ä¸­çš„æ‰€æœ‰Excelæ–‡ä»¶(.xlsx/.xls),æ–‡ä»¶åå°†ä½œä¸ºç­çº§åç§°
                </small>
            </div>
            <button id="batchAnalyzeBtn" style="background:#4caf50;">
                âš¡ å¼€å§‹æ‰¹é‡åˆ†æ
            </button>
            <div id="batchProgress" style="display:none; margin-top:15px; padding:15px; background:white; border-radius:8px; border-left:4px solid #4caf50;">
                <div style="font-weight:600; margin-bottom:10px;">ğŸ“Š æ‰¹é‡åˆ†æè¿›åº¦</div>
                <div id="batchProgressText" style="color:#666; line-height:1.8;"></div>
            </div>
        </div>

        <!-- ç­çº§åˆ—è¡¨ -->
        <div class="section">
            <h2>ğŸ“‹ å·²é…ç½®ç­çº§åˆ—è¡¨</h2>
            <div id="classList" class="class-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // åŠ è½½ç­çº§åˆ—è¡¨
        async function loadClassList() {
            try {
                const response = await fetch(`${API_BASE}/api/class_data/profiles`);
                const result = await response.json();

                const classList = document.getElementById('classList');

                if (result.success && result.count > 0) {
                    classList.innerHTML = '';
                    Object.entries(result.data).forEach(([className, profile]) => {
                        const weaknesses = profile.trained_weaknesses || 'æ— ';
                        const weaknessArray = weaknesses.split('ã€');
                        const weaknessBadges = weaknessArray.map(w =>
                            `<span style="display:inline-block; background:#e3f2fd; color:#1976d2; padding:4px 10px; border-radius:12px; font-size:12px; margin:2px;">${w}</span>`
                        ).join('');

                        // æ–°å¢ï¼šå­¦ç”Ÿåˆ†ç»„ä¿¡æ¯
                        let studentGroupsHtml = '';
                        if (profile.student_groups && Object.keys(profile.student_groups).length > 0) {
                            const groupCount = Object.keys(profile.student_groups).length;
                            const topGroups = Object.entries(profile.student_groups).slice(0, 3);

                            studentGroupsHtml = `
                                <p style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                                    <strong>ğŸ‘¥ å­¦ç”Ÿåˆ†ç»„ï¼š</strong>å…±${groupCount}ä¸ªåˆ†ç»„<br>
                                    <span style="font-size:12px; color:#666; line-height:1.6;">
                            `;

                            topGroups.forEach(([groupKey, groupInfo]) => {
                                studentGroupsHtml += `â€¢ ${groupKey}ç»„(${groupInfo.count}äºº)<br>`;
                            });

                            if (groupCount > 3) {
                                studentGroupsHtml += `â€¢ ç­‰${groupCount}ä¸ªåˆ†ç»„...`;
                            }

                            studentGroupsHtml += `
                                    </span>
                                </p>
                            `;
                        }

                        // ç”Ÿæˆè¯¦ç»†çš„å­¦ç”Ÿåˆ†ç»„ä¿¡æ¯
                        let detailsHtml = '';
                        if (profile.student_groups && Object.keys(profile.student_groups).length > 0) {
                            detailsHtml = '<div class="class-card-details" id="details-' + className.replace(/\s/g, '_') + '">';
                            detailsHtml += '<h4 style="color:#667eea; margin-bottom:10px;">ğŸ“Š è¯¦ç»†å­¦ç”Ÿåˆ†ç»„ä¿¡æ¯</h4>';

                            Object.entries(profile.student_groups).forEach(([groupKey, groupInfo]) => {
                                detailsHtml += `
                                    <div class="student-group-detail">
                                        <h4>ğŸ“Œ ${groupKey}è–„å¼±ç»„ï¼ˆ${groupInfo.count}äººï¼‰</h4>
                                        <p style="font-size:12px; color:#666; margin-bottom:6px;">
                                            <strong>è–„å¼±é¡¹ç›®ï¼š</strong>${groupInfo.weakness_items.join('ã€')}
                                        </p>
                                `;

                                if (groupInfo.student_details && groupInfo.student_details.length > 0) {
                                    detailsHtml += '<div class="student-list">';
                                    groupInfo.student_details.forEach(student => {
                                        const studentId = student['å­¦ç”Ÿç¼–å·'] || student['å­¦å·'] || '';
                                        const studentName = student['å§“å'] || '';
                                        const studentIndex = student['åºå·'] || '';

                                        // ä¼˜åŒ–æ˜¾ç¤ºï¼šå­¦ç”ŸXï¼ˆå­¦ç”Ÿç¼–å·ï¼‰æˆ– å§“åï¼ˆå­¦ç”Ÿç¼–å·ï¼‰
                                        let displayText = '';
                                        if (studentName) {
                                            // æœ‰å§“åï¼šæ˜¾ç¤º"å§“å [å­¦ç”Ÿç¼–å·]"
                                            if (studentId) {
                                                displayText = `${studentName} <span style="color:#666; font-size:11px;">[${studentId}]</span>`;
                                            } else {
                                                displayText = studentName;
                                            }
                                        } else {
                                            // æ²¡æœ‰å§“åï¼šæ˜¾ç¤º"å­¦ç”ŸX [å­¦ç”Ÿç¼–å·]"
                                            const indexText = studentIndex ? `å­¦ç”Ÿ${studentIndex}` : 'å­¦ç”Ÿ';
                                            if (studentId) {
                                                displayText = `${indexText} <span style="color:#666; font-size:11px;">[${studentId}]</span>`;
                                            } else {
                                                displayText = indexText;
                                            }
                                        }
                                        detailsHtml += `<span class="student-tag">${displayText}</span>`;
                                    });
                                    detailsHtml += '</div>';
                                }

                                detailsHtml += '</div>';
                            });

                            detailsHtml += '</div>';
                        }

                        const card = document.createElement('div');
                        card.className = 'class-card';
                        const cardId = 'card-' + className.replace(/\s/g, '_');
                        card.id = cardId;
                        card.innerHTML = `
                            <div onclick="toggleDetails('${className.replace(/\s/g, '_')}')">
                                <h3>${className} <span style="font-size:14px; color:#999;">â–¼</span></h3>
                                <p><strong>å¹´çº§ï¼š</strong>${profile.grades_query}å¹´çº§</p>
                                <p><strong>è–„å¼±é¡¹ï¼š</strong><br>${weaknessBadges}</p>
                                <p style="font-size:13px; color:#666; margin-top:10px;">${profile.description}</p>
                                ${studentGroupsHtml}
                            </div>
                            ${detailsHtml}
                            <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee;">
                                <button class="btn-download" onclick="event.stopPropagation(); downloadClassWord('${className}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ“„ ä¸‹è½½Word</button>
                                <button class="btn-download" onclick="event.stopPropagation(); downloadClassExcel('${className}')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">ğŸ“Š ä¸‹è½½Excel</button>
                                <button onclick="event.stopPropagation(); deleteClass('${className}')">ğŸ—‘ï¸ åˆ é™¤é…ç½®</button>
                            </div>
                        `;
                        classList.appendChild(card);
                    });
                } else {
                    classList.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— ç­çº§é…ç½®</p>';
                }
            } catch (error) {
                console.error('åŠ è½½ç­çº§åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åŠ è½½ç­çº§åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // ä¸Šä¼ æ–‡ä»¶ï¼ˆä½¿ç”¨æµå¼APIï¼‰
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const className = document.getElementById('className').value;
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('è¯·é€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('class_name', className);

            // æ˜¾ç¤ºåˆ†æåŒºåŸŸ
            const analysisSection = document.getElementById('analysisSection');
            const progressLog = document.getElementById('progressLog');
            const resultCard = document.getElementById('resultCard');

            analysisSection.style.display = 'block';
            progressLog.innerHTML = '<div style="color:#667eea; font-weight:bold; margin-bottom:10px;">ğŸ“Š åˆ†ææ—¥å¿—</div>';
            resultCard.style.display = 'none';
            resultCard.innerHTML = '';

            // æ»šåŠ¨åˆ°åˆ†æåŒºåŸŸ
            analysisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // ç¦ç”¨ä¸Šä¼ æŒ‰é’®
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadBtnText = document.getElementById('uploadBtnText');
            uploadBtn.disabled = true;
            uploadBtnText.textContent = 'â³ åˆ†æä¸­...';

            let analysisResult = null;

            try {
                const response = await fetch(`${API_BASE}/api/class_data/upload_stream`, {
                    method: 'POST',
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                // æ˜¾ç¤ºç»“æœå¡ç‰‡
                                if (analysisResult) {
                                    showResultCard(analysisResult, className);
                                }
                                showMessage('âœ… åˆ†æå®Œæˆï¼', 'success');
                                document.getElementById('uploadForm').reset();
                                loadClassList();
                                break;
                            }

                            try {
                                const json = JSON.parse(data);
                                if (json.type === 'progress') {
                                    // åªæ˜¾ç¤ºå…³é”®ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºåŸå§‹æ•°æ®
                                    const content = json.content;
                                    if (!content.includes('```') && !content.includes('{') && !content.includes('}')) {
                                        progressLog.innerHTML += content;
                                        progressLog.scrollTop = progressLog.scrollHeight;
                                    }
                                } else if (json.type === 'success') {
                                    analysisResult = json.profile;
                                    progressLog.innerHTML += '\n<div style="color:#4caf50; font-weight:bold; margin-top:10px;">âœ… ' + json.message + '</div>\n';
                                    progressLog.scrollTop = progressLog.scrollHeight;
                                } else if (json.type === 'error') {
                                    progressLog.innerHTML += '\n<div style="color:#f44336; font-weight:bold;">âŒ ' + json.message + '</div>\n';
                                    showMessage(json.message, 'error');
                                }
                            } catch (e) {
                                console.error('è§£æJSONå¤±è´¥:', e, data);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showMessage('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtnText.textContent = 'ğŸš€ å¼€å§‹åˆ†æ';
            }
        });

        // æ˜¾ç¤ºç»“æœå¡ç‰‡
        function showResultCard(profile, className) {
            const resultCard = document.getElementById('resultCard');
            const weaknesses = profile.trained_weaknesses.split('ã€');
            const weaknessBadges = weaknesses.map(w =>
                `<span class="weakness-badge">${w}</span>`
            ).join('');

            let detailsHtml = '';
            if (profile.weakness_details) {
                for (const [dimension, detail] of Object.entries(profile.weakness_details)) {
                    detailsHtml += `
                        <div class="result-item">
                            <strong>ğŸ¯ ${dimension}</strong>
                            <div style="font-size:13px; line-height:1.6;">${detail}</div>
                        </div>
                    `;
                }
            }

            // æ–°å¢ï¼šå­¦ç”Ÿåˆ†ç»„ä¿¡æ¯
            let studentGroupsHtml = '';
            if (profile.student_groups && Object.keys(profile.student_groups).length > 0) {
                studentGroupsHtml = `
                    <div class="result-item">
                        <strong>ğŸ‘¥ å­¦ç”Ÿåˆ†ç»„æƒ…å†µ</strong>
                        <div style="font-size:13px; line-height:1.8; margin-top:8px;">
                `;

                for (const [groupKey, groupInfo] of Object.entries(profile.student_groups)) {
                    const count = groupInfo.count || 0;
                    const students = groupInfo.students || [];
                    const studentDetails = groupInfo.student_details || [];
                    const weaknessItems = groupInfo.weakness_items || [];

                    studentGroupsHtml += `
                        <div style="margin-bottom:10px; padding:8px; background:rgba(255,255,255,0.15); border-radius:6px;">
                            <div style="font-weight:600; margin-bottom:4px;">
                                ğŸ“Œ ${groupKey}è–„å¼±ç»„ï¼š${count}äºº
                            </div>
                            ${weaknessItems.length > 0 ? `
                                <div style="font-size:12px; opacity:0.9; margin-bottom:4px;">
                                    è–„å¼±é¡¹ç›®ï¼š${weaknessItems.slice(0, 3).join('ã€')}${weaknessItems.length > 3 ? 'ç­‰' : ''}
                                </div>
                            ` : ''}
                            ${studentDetails.length > 0 && studentDetails.length <= 10 ? `
                                <div style="font-size:12px; opacity:0.85; margin-top:6px;">
                                    <div style="font-weight:500; margin-bottom:4px;">å­¦ç”Ÿåå•ï¼š</div>
                                    ${studentDetails.map(s => {
                                        const studentName = s.å§“å || '';
                                        const studentId = s.å­¦ç”Ÿç¼–å· || s.å­¦å· || '';
                                        const studentIndex = s.åºå· || '';

                                        let info = '';
                                        if (studentName) {
                                            // æœ‰å§“åï¼šæ˜¾ç¤º"å§“å [å­¦ç”Ÿç¼–å·]"
                                            if (studentId) {
                                                info = `${studentName} <span style="color:#999; font-size:11px;">[${studentId}]</span>`;
                                            } else {
                                                info = studentName;
                                            }
                                        } else {
                                            // æ²¡æœ‰å§“åï¼šæ˜¾ç¤º"å­¦ç”ŸX [å­¦ç”Ÿç¼–å·]"
                                            const indexText = studentIndex ? `å­¦ç”Ÿ${studentIndex}` : 'å­¦ç”Ÿ';
                                            if (studentId) {
                                                info = `${indexText} <span style="color:#999; font-size:11px;">[${studentId}]</span>`;
                                            } else {
                                                info = indexText;
                                            }
                                        }
                                        return `<div style="padding:2px 0;">â€¢ ${info}</div>`;
                                    }).join('')}
                                </div>
                            ` : students.length > 0 && students.length <= 5 ? `
                                <div style="font-size:12px; opacity:0.85;">
                                    å­¦ç”Ÿï¼š${students.join('ã€')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                studentGroupsHtml += `
                        </div>
                    </div>
                `;
            }

            resultCard.innerHTML = `
                <div class="result-card fade-in">
                    <h3>ğŸ‰ ${className} åˆ†æå®Œæˆ</h3>
                    <div class="result-item">
                        <strong>ğŸ“š å¹´çº§</strong>
                        <div>${profile.grades_query}å¹´çº§</div>
                    </div>
                    <div class="result-item">
                        <strong>âš ï¸ è–„å¼±é¡¹ç»´åº¦</strong>
                        <div>${weaknessBadges}</div>
                    </div>
                    ${detailsHtml}
                    ${studentGroupsHtml}
                    <div style="margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.2); font-size:13px; opacity:0.9;">
                        ğŸ’¡ è¯¥ç­çº§ä¿¡æ¯å·²ä¿å­˜ï¼Œåœ¨é—®ç­”æ—¶æåˆ°"${className}"å°†è‡ªåŠ¨è¯†åˆ«å¹¶ä¸ºä¸åŒè–„å¼±é¡¹çš„å­¦ç”Ÿæ¨èå·®å¼‚åŒ–ç»ƒä¹ 
                    </div>
                </div>
            `;
            resultCard.style.display = 'block';

            // æ»šåŠ¨åˆ°ç»“æœå¡ç‰‡
            setTimeout(() => {
                resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        }

        // æ‰¹é‡åˆ†æ
        document.getElementById('batchAnalyzeBtn').addEventListener('click', async () => {
            const folderInput = document.getElementById('batchFolderInput');
            const allFiles = folderInput.files;

            if (allFiles.length === 0) {
                showMessage('è¯·å…ˆé€‰æ‹©åŒ…å«ä½“æµ‹æ•°æ®çš„æ–‡ä»¶å¤¹', 'error');
                return;
            }

            // è¿‡æ»¤å‡ºExcelæ–‡ä»¶
            const excelFiles = Array.from(allFiles).filter(file => {
                return file.name.match(/\.(xlsx|xls)$/i);
            });

            if (excelFiles.length === 0) {
                showMessage('æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°Excelæ–‡ä»¶(.xlsx/.xls)', 'error');
                return;
            }

            if (!confirm(`åœ¨æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ° ${excelFiles.length} ä¸ªExcelæ–‡ä»¶ï¼Œç¡®å®šè¦æ‰¹é‡åˆ†æå—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚`)) {
                return;
            }

            const btn = document.getElementById('batchAnalyzeBtn');
            const progressDiv = document.getElementById('batchProgress');
            const progressText = document.getElementById('batchProgressText');

            btn.disabled = true;
            btn.textContent = 'â³ åˆ†æä¸­...';
            progressDiv.style.display = 'block';
            progressText.innerHTML = `ğŸ“ æ‰¾åˆ° ${excelFiles.length} ä¸ªExcelæ–‡ä»¶ï¼Œå‡†å¤‡å¼€å§‹æ‰¹é‡åˆ†æ...`;

            let successCount = 0;
            let failCount = 0;
            const results = [];

            try {
                for (let i = 0; i < excelFiles.length; i++) {
                    const file = excelFiles[i];
                    // ä»æ–‡ä»¶åæå–ç­çº§åç§°(å»æ‰æ‰©å±•å)
                    const className = file.name.replace(/\.(xlsx|xls)$/i, '');

                    progressText.innerHTML = `
                        ğŸ“Š æ­£åœ¨åˆ†æ: <strong>${className}</strong> (${i + 1}/${excelFiles.length})<br>
                        âœ… æˆåŠŸ: ${successCount} | âŒ å¤±è´¥: ${failCount}
                    `;

                    try {
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('class_name', className);

                        const response = await fetch(`${API_BASE}/api/class_data/upload`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            successCount++;
                            results.push({ className, success: true });
                        } else {
                            failCount++;
                            results.push({ className, success: false, error: result.message });
                        }
                    } catch (error) {
                        failCount++;
                        results.push({ className, success: false, error: error.message });
                    }
                }

                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                progressText.innerHTML = `
                    <div style="font-size:16px; margin-bottom:10px;">
                        ğŸ‰ æ‰¹é‡åˆ†æå®Œæˆï¼
                    </div>
                    <div style="display:flex; gap:20px; margin-bottom:15px;">
                        <div style="color:#4caf50;">âœ… æˆåŠŸ: <strong>${successCount}</strong></div>
                        <div style="color:#f44336;">âŒ å¤±è´¥: <strong>${failCount}</strong></div>
                        <div style="color:#666;">ğŸ“Š æ€»è®¡: <strong>${excelFiles.length}</strong></div>
                    </div>
                    ${failCount > 0 ? `
                        <div style="margin-top:10px; padding:10px; background:#fff3cd; border-radius:4px; font-size:13px;">
                            <strong>å¤±è´¥çš„ç­çº§:</strong><br>
                            ${results.filter(r => !r.success).map(r => `â€¢ ${r.className}: ${r.error}`).join('<br>')}
                        </div>
                    ` : ''}
                `;

                showMessage(`æ‰¹é‡åˆ†æå®Œæˆï¼æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, successCount > 0 ? 'success' : 'error');

                // åˆ·æ–°ç­çº§åˆ—è¡¨
                if (successCount > 0) {
                    loadClassList();
                }

                // æ¸…ç©ºæ–‡ä»¶å¤¹é€‰æ‹©
                folderInput.value = '';

            } catch (error) {
                console.error('æ‰¹é‡åˆ†æå¤±è´¥:', error);
                showMessage('æ‰¹é‡åˆ†æå¤±è´¥: ' + error.message, 'error');
                progressText.innerHTML = `âŒ æ‰¹é‡åˆ†æå¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'âš¡ å¼€å§‹æ‰¹é‡åˆ†æ';
            }
        });

        // åˆ‡æ¢è¯¦æƒ…æ˜¾ç¤º
        function toggleDetails(classId) {
            const detailsEl = document.getElementById('details-' + classId);
            if (detailsEl) {
                detailsEl.classList.toggle('show');
                // æ›´æ–°ç®­å¤´æ–¹å‘
                const card = document.getElementById('card-' + classId);
                const arrow = card.querySelector('h3 span');
                if (arrow) {
                    arrow.textContent = detailsEl.classList.contains('show') ? 'â–²' : 'â–¼';
                }
            }
        }

        // ä¸‹è½½ç­çº§é…ç½®ï¼ˆWordæ ¼å¼ï¼‰
        async function downloadClassWord(className) {
            try {
                const downloadUrl = `${API_BASE}/api/class_data/download_word/${encodeURIComponent(className)}`;

                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `${className}_é…ç½®.docx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(`${className} é…ç½®å·²ä¸‹è½½ä¸ºWordæ–‡æ¡£`, 'success');
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                showMessage('ä¸‹è½½å¤±è´¥', 'error');
            }
        }

        // ä¸‹è½½ç­çº§é…ç½®ï¼ˆExcelæ ¼å¼ï¼‰
        async function downloadClassExcel(className) {
            try {
                const downloadUrl = `${API_BASE}/api/class_data/download/${encodeURIComponent(className)}`;

                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `${className}_é…ç½®.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(`${className} é…ç½®å·²ä¸‹è½½ä¸ºExcelæ–‡ä»¶`, 'success');
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                showMessage('ä¸‹è½½å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ç­çº§
        async function deleteClass(className) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${className} çš„é…ç½®å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/class_data/profile/${encodeURIComponent(className)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    loadClassList();
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ–‡ä»¶é€‰æ‹©åè‡ªåŠ¨å¡«å……ç­çº§åç§°
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // æå–æ–‡ä»¶åï¼ˆå»æ‰æ‰©å±•åï¼‰
                const fileName = file.name;
                const className = fileName.replace(/\.(xlsx|xls)$/i, '');

                // è‡ªåŠ¨å¡«å……åˆ°ç­çº§åç§°è¾“å…¥æ¡†
                document.getElementById('className').value = className;
            }
        });

        // é¡µé¢åŠ è½½æ—¶åŠ è½½ç­çº§åˆ—è¡¨
        loadClassList();
    </script>
</body>
</html>

