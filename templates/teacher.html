<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å¤‡è¯¾åŠ©ç†</title>
  <style>
    :root {
      --bg:#f7f8fa;
      --card:#ffffff;
      --text:#222;
      --text-secondary:#555;
      --muted:#666;
      --primary:#2b6de9;
      --primary-hover:#1e5dd8;
      --bubble:#eef3ff;
      --border:#e5e7eb;
      --code-bg:#f4f6fa;
      --success:#10b981;
      --warning:#f59e0b;
    }

    * { box-sizing: border-box; }

    body {
      margin:0;
      background:var(--bg);
      font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      color:var(--text);
    }

    header {
      padding:16px 20px;
      background:#fff;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    header h1 {
      margin:0;
      font-size:18px;
      font-weight:600;
      color:var(--primary);
    }

    .nav-link {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 16px;
      background:var(--primary);
      color:#fff;
      text-decoration:none;
      border-radius:8px;
      font-size:13px;
      font-weight:500;
      transition: all 0.2s;
    }

    .nav-link:hover {
      background:var(--primary-hover);
      transform: translateY(-1px);
    }

    .container {
      max-width:1000px;
      margin:20px auto;
      padding:0 16px;
    }

    .chat-card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:80vh;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .toolbar {
      padding:12px;
      border-bottom:1px solid var(--border);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      background:#fafbfc;
    }

    .chip {
      border:1px solid #e2e7f3;
      color:#3a64c6;
      background:#f2f6ff;
      padding:6px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      transition: all 0.2s;
    }

    .chip:hover {
      background:#e8efff;
      border-color:#d0ddf5;
    }

    .chip:disabled {
      opacity:.6;
      cursor:default;
    }

    .chat {
      flex:1;
      padding:20px;
      overflow:auto;
      background:linear-gradient(180deg,#fafbff, #fff);
    }

    .msg {
      max-width:85%;
      margin:12px 0;
      display:flex;
      gap:10px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg.assistant {
      justify-content:flex-start;
    }

    .msg.user {
      justify-content:flex-end;
      margin-left:auto;
    }

    .bubble {
      padding:12px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      word-wrap: break-word;
      white-space: normal;
      overflow-wrap: break-word;
    }

    .assistant .bubble {
      background:var(--bubble);
      border-color:#dbe5ff;
    }

    .user .bubble {
      background:#e8f5ff;
      border-color:#cde8ff;
    }

    .inputbar {
      border-top:1px solid var(--border);
      padding:12px;
      display:flex;
      gap:10px;
      background:#fafbfc;
    }

    .inputbar textarea {
      flex:1;
      resize:none;
      height:52px;
      padding:12px;
      border-radius:8px;
      border:1px solid var(--border);
      outline:none;
      font-size:14px;
      transition: border-color 0.2s;
    }

    .inputbar textarea:focus {
      border-color:var(--primary);
    }

    .btn {
      background:var(--primary);
      color:#fff;
      border:none;
      padding:12px 20px;
      border-radius:8px;
      cursor:pointer;
      font-weight:500;
      transition: background 0.2s;
    }

    .btn:hover {
      background:var(--primary-hover);
    }

    .hint {
      color:#415a9a;
      background:#eef3ff;
      border:1px solid #dbe5ff;
      padding:10px 12px;
      border-radius:8px;
      font-size:13px;
      line-height:1.5;
    }

    .ask {
      margin-top:8px;
      padding-top:8px;
      border-top:1px solid #dbe5ff;
    }

    .small {
      font-size:12px;
      color:#6b7280;
    }

    code {
      background:var(--code-bg);
      padding:2px 6px;
      border-radius:4px;
      font-size:12px;
      font-family: 'Consolas', 'Monaco', monospace;
    }

    /* Markdown å†…å®¹æ ·å¼ä¼˜åŒ– */
    .bubble h1 {
      font-size:18px;
      font-weight:700;
      margin:20px 0 12px 0;
      color:#1f2937;
      line-height:1.4;
      display:block;
      padding-bottom:8px;
      border-bottom:2px solid #e5e7eb;
    }

    .bubble h1:first-child {
      margin-top:0;
    }

    .bubble h2 {
      font-size:16px;
      font-weight:600;
      margin:18px 0 10px 0;
      color:#374151;
      line-height:1.4;
      display:block;
      padding-left:8px;
      border-left:3px solid #3b82f6;
    }

    .bubble h3 {
      font-size:14px;
      font-weight:600;
      margin:14px 0 8px 0;
      color:#4b5563;
      line-height:1.4;
      display:block;
      background:#f9fafb;
      padding:6px 10px;
      border-radius:4px;
    }

    /* æ ‡é¢˜ä¸­å†æ¬¡åŠ ç²—æ—¶ä¿æŒä¸€è‡´ç²—ç»†ï¼Œé¿å…è¿‡äºåšé‡ */
    .bubble h1 strong, .bubble h1 b,
    .bubble h2 strong, .bubble h2 b,
    .bubble h3 strong, .bubble h3 b,
    .bubble h4 strong, .bubble h4 b {
      font-weight: inherit;
    }


    .bubble h4 {
      font-size:13px;
      font-weight:600;
      margin:12px 0 6px 0;
      color:#6b7280;
      line-height:1.4;
      display:block;
    }

    .bubble p {
      margin:10px 0;
      line-height:1.8;
      font-size:13px;
      display:block;
      color:#374151;
    }

    .bubble ul, .bubble ol {
      margin:12px 0;
      padding-left:28px;
      font-size:13px;
      display:block;
      line-height:1.7;
    }

    .bubble li {
      margin:6px 0;
      line-height:1.7;
      display:list-item;
      color:#4b5563;
    }

    .bubble li p {
      margin:2px 0;
      display:inline;
    }

    /* ç¦ç”¨åˆ é™¤çº¿æ ·å¼ */
    .bubble del, .bubble s {
      text-decoration: none;
      color: var(--text);
    }

    /* ç¡®ä¿å—çº§å…ƒç´ æ­£ç¡®æ˜¾ç¤º */
    .bubble > h1, .bubble > h2, .bubble > h3, .bubble > h4, .bubble > h5, .bubble > h6,
    .bubble > p, .bubble > ul, .bubble > ol, .bubble > table, .bubble > hr, .bubble > blockquote {
      display:block;
    }

    /* åŠ ç²—æ–‡æœ¬æ ·å¼ */
    .bubble strong, .bubble b {
      font-weight: 600;
      color: #1f2937;
    }

    /* åˆ†éš”çº¿æ ·å¼ */
    .bubble hr {
      border: none;
      border-top: 2px solid #e5e7eb;
      margin: 20px 0;
    }

    /* å¼•ç”¨å—æ ·å¼ */
    .bubble blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 16px;
      margin: 12px 0;
      color: #6b7280;
      font-style: italic;
    }



    .bubble table {
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin:12px 0;
      font-size:12px;
      border:1px solid #eef2f7;
      border-radius:8px;
      overflow:hidden;
      background:#fff;
    }

    .bubble th {
      background:#fafbfc;
      padding:10px 12px;
      text-align:left;
      font-weight:600;
      border-bottom:1px solid #eef2f7;
      font-size:12px;
    }

    .bubble td {
      padding:10px 12px;
      border-top:1px solid #f2f4f8;
      font-size:12px;
    }

    .bubble tbody tr:nth-child(odd) {
      background:#fafbfe;
    }

    /* å›¾ç‰‡å®¹å™¨ */
    .bubble .img-container {
      text-align: center;
      margin: 16px 0;
    }

    .bubble img {
      display:block;
      margin:8px auto;
      max-width:260px;
      width:auto;
      height:auto;
      max-height:180px;
      object-fit:contain;
      border-radius:8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
    }

    .bubble img[src=""], .bubble img:not([src]) {
      display:none;
    }

    /* å›¾ç‰‡åç§° */
    .bubble .img-name {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
      text-align: center;
      font-style: italic;
    }

    /* å›¾ç‰‡åŠ è½½å¤±è´¥å ä½ç¬¦ */
    .img-placeholder {
      padding: 12px;
      background: #f9fafb;
      border: 1px dashed #d1d5db;
      border-radius: 6px;
      color: #9ca3af;
      font-size: 12px;
      text-align: center;
      margin: 12px 0;
    }

    /* ä¼˜åŒ–æ¨ªçº¿æ ·å¼ */
    .bubble hr {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 16px 0;
    }

    /* JSONæ¸²æŸ“ä¸“ç”¨æ ·å¼ */
    .plan-title {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 24px 0;
      padding-bottom: 12px;
      border-bottom: 3px solid #3b82f6;
      text-align: center;
    }

    .section-title {
      font-size: 17px;
      font-weight: 600;
      color: #374151;
      margin: 24px 0 16px 0;
      padding: 10px 12px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-radius: 6px;
    }

    .subsection {
      margin: 16px 0;
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
    }

    .subsection-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 10px 0;
    }

    .subsection-content {
      font-size: 14px;
      color: #4b5563;
      line-height: 1.6;
      margin: 8px 0;
    }

    .subsection-list {
      margin: 8px 0;
      padding-left: 24px;
      list-style-type: disc;
    }

    .subsection-list li {
      font-size: 14px;
      color: #4b5563;
      line-height: 1.6;
      margin: 4px 0;
    }

    .plan-table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
      background: white;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .plan-table th {
      background: #3b82f6;
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: 600;
    }

    .plan-table td {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      color: #4b5563;
    }

    .plan-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .plan-table tbody tr:hover {
      background: #eff6ff;
    }

    .project-card {
      margin: 16px 0;
      padding: 16px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .project-name {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #3b82f6;
    }

    .project-details {
      margin: 12px 0;
      padding-left: 20px;
      list-style-type: none;
    }

    .project-details li {
      font-size: 14px;
      color: #4b5563;
      line-height: 1.7;
      margin: 6px 0;
      padding-left: 16px;
      position: relative;
    }

    .project-details li:before {
      content: "â–¸";
      position: absolute;
      left: 0;
      color: #3b82f6;
      font-weight: bold;
    }

    .project-image-container {
      margin: 16px 0;
      text-align: center;
    }

    .project-image {
      display: inline-block;
      max-width: 200px;
      max-height: 150px;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
    }

    .loading-hint {
      padding: 20px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      background: #f9fafb;
      border-radius: 6px;
      border: 1px dashed #d1d5db;
    }

    .bubble blockquote {
      border-left:2px solid #e5e7eb;
      padding-left:12px;
      margin:10px 0;
      color:#6b7280;
      font-style:italic;
      background:#fafbff;
      border-radius:4px;
    }

    .bubble pre {
      background:var(--code-bg);
      padding:12px;
      border-radius:6px;
      overflow-x:auto;
      margin:8px 0;
    }

    .bubble pre code {
      background:transparent;
      padding:0;
      font-size:12px;
    }

    .bubble hr {
      border:none;
      border-top:1px dashed #e5e7eb;
      margin:14px 0;
    }

    .bubble strong {
      font-weight:600;
      color:var(--text);
    }

    .bubble em {
      font-style:italic;
      color:var(--text-secondary);
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    .chat::-webkit-scrollbar {
      width:8px;
    }

    .chat::-webkit-scrollbar-track {
      background:#f1f1f1;
    }

    .chat::-webkit-scrollbar-thumb {
      background:#c1c1c1;
      border-radius:4px;
    }

    .chat::-webkit-scrollbar-thumb:hover {
      background:#a8a8a8;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        padding: 0 8px;
        margin: 10px auto;
      }

      .chat-card {
        height: 85vh;
        border-radius: 8px;
      }

      .msg {
        max-width: 90%;
      }

      .bubble {
        padding: 10px 12px;
      }

      .bubble h1 {
        font-size: 16px;
      }

      .bubble h2 {
        font-size: 14px;
      }

      .toolbar {
        padding: 8px;
      }

      .chip {
        font-size: 11px;
        padding: 5px 10px;
      }

      header h1 {
        font-size: 16px;
      }

      .inputbar textarea {
        height: 44px;
        font-size: 13px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }
    }

    /* æ‰“å°æ ·å¼ */
    @media print {
      header, .toolbar, .inputbar {
        display: none;
      }

      .chat-card {
        border: none;
        box-shadow: none;
        height: auto;
      }

      .chat {
        overflow: visible;
      }

      .msg {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; gap:12px;">
      <h1>ğŸ“ AIå¤‡è¯¾åŠ©ç†</h1>
      <span class="small">æ™ºèƒ½å¯¹è¯ Â· æ”¯æŒè¯¾è¯¾ç»ƒä¸å…¨å‘˜è¿åŠ¨ä¼šæ–¹æ¡ˆç”Ÿæˆ</span>
    </div>
    <a href="/class_data_manager" class="nav-link">
      ğŸ“Š ç­çº§ä½“æµ‹æ•°æ®ç®¡ç†
    </a>
  </header>
  <div class="container">
    <div class="chat-card" id="card">
      <div class="toolbar">
        <button class="chip" id="btnInit">ğŸ’¬ å¼€å§‹å¯¹è¯</button>
        <button class="chip" id="btnDemo1">ğŸ“ ç¤ºä¾‹ï¼šè¯¾è¯¾ç»ƒ</button>
        <button class="chip" id="btnDemo2">ğŸƒ ç¤ºä¾‹ï¼šå…¨å‘˜è¿åŠ¨ä¼š</button>
      </div>
      <div class="chat" id="chat"></div>
      <div class="inputbar">
        <textarea id="input" placeholder="è¯·æè¿°æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šä¸‰å¹´çº§çƒç±»è¿åŠ¨ä¼šã€ä¸€å¹´çº§é€Ÿåº¦è®­ç»ƒè¯¾è¯¾ç»ƒ..."></textarea>
        <button class="btn" id="send">ğŸ’¬ å‘é€</button>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/marked@12.0.2/marked.min.js"></script>
  <script src="https://unpkg.com/dompurify@3.1.6/dist/purify.min.js"></script>
  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    // å¯¹è¯å†å²è®°å½•
    let conversationHistory = [];
    let chatRestored = false; // æ ‡è®°æ˜¯å¦æ¢å¤äº†å¯¹è¯

    // æ£€æŸ¥æ˜¯å¦ä»ç­çº§ç®¡ç†ç³»ç»Ÿè¿”å›
    const returnFromClassManager = sessionStorage.getItem('returnFromClassManager');
    if (returnFromClassManager === 'true') {
      // æ¢å¤å¯¹è¯å†å²
      const savedHistory = sessionStorage.getItem('conversationHistory');
      if (savedHistory) {
        try {
          conversationHistory = JSON.parse(savedHistory);
          chatRestored = true;
          console.log('âœ… å·²æ¢å¤å¯¹è¯å†å²ï¼Œå…±', conversationHistory.length, 'æ¡è®°å½•');
        } catch (e) {
          console.error('æ¢å¤å¯¹è¯å†å²å¤±è´¥:', e);
        }
      }

      // æ¢å¤èŠå¤©ç•Œé¢
      const savedChat = sessionStorage.getItem('chatHTML');
      if (savedChat) {
        chatEl.innerHTML = savedChat;
        chatEl.scrollTop = chatEl.scrollHeight;
        console.log('âœ… å·²æ¢å¤èŠå¤©ç•Œé¢');
      }

      // æ¸…é™¤æ ‡è®°
      sessionStorage.removeItem('returnFromClassManager');
    }

    // é…ç½® marked.js
    marked.setOptions({
      breaks: true,        // æ”¯æŒGFMæ¢è¡Œï¼ˆå•ä¸ª\nå°±æ¢è¡Œï¼‰
      gfm: true,          // å¯ç”¨GitHub Flavored Markdown
      headerIds: false,   // ç¦ç”¨æ ‡é¢˜ID
      mangle: false       // ç¦ç”¨é‚®ç®±æ··æ·†
    });

    // ä¿®å¤å›¾ç‰‡/é“¾æ¥çš„Markdownæ ¼å¼ï¼Œé¿å…URLè¢«é”™è¯¯åå¹¶åç»­ç¬¦å·ï¼ˆå¦‚###ã€ä¸­æ–‡æ ‡é¢˜ç­‰ï¼‰
    function fixImageMarkdown(text) {
      if (!text) return text;

      let fixed = text;
      let totalFixes = 0;

      // 0) å°†â€œå›¾ç‰‡é“¾æ¥ï¼šURLâ€ç­‰æ–‡æœ¬è§„èŒƒä¸ºæ ‡å‡†Markdownå›¾ç‰‡ï¼Œå¹¶åªæˆªå–åˆ°å›¾ç‰‡æ‰©å±•å
      const plainImgPattern = /(å›¾ç‰‡é“¾æ¥|å›¾ç‰‡|ç¤ºæ„å›¾|ç»ƒä¹ ç¤ºæ„å›¾)\s*[:ï¼š]\s*(https?:\/\/[^\s)]+?\.(?:png|jpe?g|gif|webp|svg))(?!\S)/gi;
      fixed = fixed.replace(plainImgPattern, (_m, _label, url) => {
        totalFixes++;
        return `![ç»ƒä¹ ç¤ºæ„å›¾](${url})`;
      });

      // 0.1) å°†â€œç»ƒä¹ ç¤ºæ„å›¾](URL)â€ç¼ºå°‘!çš„é”™è¯¯è¯­æ³•ä¿®æ­£ä¸ºå›¾ç‰‡
      const missingBangImg = /(^|[\s>])([^\[\n]{1,20})\]\((https?:\/\/[^\s)]+?\.(?:png|jpe?g|gif|webp|svg))\)/g;
      fixed = fixed.replace(missingBangImg, (m, lead, alt, url) => {
        totalFixes++;
        return `${lead}![${alt}](${url})`;
      });

      // 0.2) å°†è£¸éœ²çš„å›¾ç‰‡URLåŒ…è£¹ä¸ºMarkdownå›¾ç‰‡ï¼ˆå°½é‡ä¿å®ˆï¼Œä»…åœ¨è¡Œé¦–æˆ–ç©ºç™½åå‡ºç°æ—¶å¤„ç†ï¼‰
      const bareImgUrl = /(\b|\s)(https?:\/\/[^\s)]+?\.(?:png|jpe?g|gif|webp|svg))(?!\S)/gim;
      fixed = fixed.replace(bareImgUrl, (m, lead, url) => {
        // é¿å…å·²åœ¨ () æˆ– [] ç»“æ„ä¸­å†æ¬¡åŒ…è£¹
        if (/(\(|\]|\))$/.test(lead)) return m;
        totalFixes++;
        return `${lead}![ç»ƒä¹ ç¤ºæ„å›¾](${url})`;
      });

      // 0.3) ä¿®å¤å½¢å¦‚ â€œ...jpg)%E4%B8%AD%E6%96%87%5D(https://...jpg)â€ çš„ä¸²è”ï¼šå°†ç¼–ç çš„altè§£ç å¹¶ç”Ÿæˆæ–°å›¾ç‰‡
      const encodedAltConcat = /\)(%[0-9A-Fa-f]{2,}(?:%[0-9A-Fa-f]{2,})*?)\((https?:\/\/[^\s)]+?\.(?:png|jpe?g|gif|webp|svg))\)/g;
      fixed = fixed.replace(encodedAltConcat, (m, encAlt, url) => {
        let alt = '';
        try { alt = decodeURIComponent(encAlt); } catch(_) { alt = encAlt; }
        alt = alt.replace(/\]$/, '').trim() || 'ç¤ºæ„å›¾';
        totalFixes++;
        return `)\n\n![${alt}](${url})`;
      });

      // 1) å›¾ç‰‡ç´§é‚»å›¾ç‰‡ï¼š![...](...)![...](...)
      const imageToImagePattern = /(!\[[^\]]*\]\([^)]+\))(!\[)/g;
      const imageToImageFixes = (fixed.match(imageToImagePattern) || []).length;
      if (imageToImageFixes > 0) {
        fixed = fixed.replace(imageToImagePattern, '$1\n\n$2');
        totalFixes += imageToImageFixes;
      }

      // 2) å›¾ç‰‡åç´§è·Ÿå…¶ä»–å­—ç¬¦ï¼ˆåŒ…æ‹¬#ã€ä¸­æ–‡ç­‰ï¼‰
      const imageToOtherPattern = /(!\[[^\]]*\]\([^)]+\))([^\s\n!])/g;
      const imageToOtherFixes = (fixed.match(imageToOtherPattern) || []).length;
      if (imageToOtherFixes > 0) {
        fixed = fixed.replace(imageToOtherPattern, '$1\n\n$2');
        totalFixes += imageToOtherFixes;
      }

      // 3) é“¾æ¥ç›¸é‚»ï¼š[...]()![ / ... / éç©ºç™½]
      const linkToImagePattern = /(\[[^\]]*\]\([^)]+\))(!\[)/g;
      const linkToOtherPattern = /(\[[^\]]*\]\([^)]+\))([^\s\n\[])/g;
      const linkFixes = (fixed.match(linkToImagePattern) || []).length + (fixed.match(linkToOtherPattern) || []).length;
      if (linkFixes > 0) {
        fixed = fixed.replace(linkToImagePattern, '$1\n\n$2');
        fixed = fixed.replace(linkToOtherPattern, '$1\n\n$2');
        totalFixes += linkFixes;
      }

      // 3.5) ç´§è´´çš„æ ‡é¢˜æ ‡è®°ï¼Œç¡®ä¿æ ‡é¢˜èµ·å§‹åœ¨æ–°è¡Œ
      const headingTight = /([^\n])(\#{1,6}\s)/g;
      if (headingTight.test(fixed)) {
        fixed = fixed.replace(headingTight, '$1\n\n$2');
        totalFixes++;
      }

      // 4) å¤„ç†å½¢å¦‚ â€œ...jpg)### ...â€ çš„æƒ…å†µï¼šåœ¨ ) ä¸ # ä¹‹é—´æ’å…¥ç©ºè¡Œ
      const closeParenToHeading = /(\)\s*)(?=\#{1,6})/g;
      if (closeParenToHeading.test(fixed)) {
        fixed = fixed.replace(closeParenToHeading, ')\n\n');
        totalFixes++;
      }

      // 5) å°è¯•ä¸ºè¡¨æ ¼è¡Œè¡¥å……æ¢è¡Œï¼ˆä¿å®ˆï¼‰
      const tableRowCompact = /([^\n])(\|[^\n]*\|[^\n]*\|)/g;
      if (tableRowCompact.test(fixed)) {
        fixed = fixed.replace(tableRowCompact, '$1\n$2');
        totalFixes++;
      }


      // 6) æŠ˜å é‡å¤çš„åˆ†éš”çº¿ï¼ˆ---ã€***ã€___ï¼‰
      const hrBlockSeq = /\n(?:[ \t]*(?:[-*_]){3,}[ \t]*\n){2,}/g;
      if (hrBlockSeq.test(fixed)) {
        fixed = fixed.replace(hrBlockSeq, '\n---\n');
        totalFixes++;
      }

      if (totalFixes > 0) {
        console.log(`âœ… ä¿®å¤äº† ${totalFixes} å¤„å›¾ç‰‡/é“¾æ¥/æ ‡é¢˜/è¡¨æ ¼æ ¼å¼é—®é¢˜`);
      }

      return fixed;
    }

    function renderMarkdown(md) {
      try {
        if (!md) return '';

        // ã€å…³é”®ã€‘å…ˆä¿®å¤å›¾ç‰‡æ ¼å¼
        const fixedMd = fixImageMarkdown(md);

        // ç›´æ¥ä½¿ç”¨marked.parse
        let html = marked.parse(fixedMd);

        // ä½¿ç”¨DOMPurifyæ¸…ç†HTML
        let sanitized = DOMPurify.sanitize(html, {
          ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'b', 'i',
                         'ul', 'ol', 'li', 'a', 'img', 'table', 'thead', 'tbody', 'tr', 'th', 'td',
                         'blockquote', 'code', 'pre', 'hr', 'div', 'span', 'del', 's'],
          ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id', 'target', 'rel']
        });

        // å¤„ç†å›¾ç‰‡ï¼šè¯†åˆ«å›¾ç‰‡åé¢ç´§è·Ÿçš„æ–‡å­—ä½œä¸ºå›¾ç‰‡åç§°
        // åŒ¹é…æ¨¡å¼ï¼š<p><img...></p> åé¢ç´§è·Ÿ <p>å›¾X ...</p>
        sanitized = sanitized.replace(/<p><img([^>]+)><\/p>\s*<p>(å›¾\d+[^<]+)<\/p>/g, (match, attrs, caption) => {
          return `<div class="img-container">
            <img${attrs}>
            <div class="img-name">${caption.trim()}</div>
          </div>`;
        });

        // å¤„ç†æ²¡æœ‰å›¾æ³¨çš„å›¾ç‰‡ï¼ˆå…œåº•ï¼‰
        // åªå¤„ç†è¿˜åœ¨<p>æ ‡ç­¾ä¸­çš„å›¾ç‰‡
        sanitized = sanitized.replace(/<p><img([^>]+)><\/p>/g, (match, attrs) => {
          const altMatch = attrs.match(/alt="([^"]+)"/);
          if (altMatch && altMatch[1]) {
            return `<div class="img-container">
              <img${attrs}>
              <div class="img-name">${altMatch[1]}</div>
            </div>`;
          }
          return `<div class="img-container">
            <img${attrs}>
          </div>`;
        });

        return sanitized;
      } catch (e) {
        console.error('Markdownæ¸²æŸ“å¤±è´¥:', e);
        return (md || '').replace(/\n/g, '<br/>');
      }
    }

    // æ¸²æŸ“JSONæ ¼å¼çš„æ–¹æ¡ˆ
    function renderJSON(jsonData) {
      try {
        const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;

        let html = '';

        // æ–¹æ¡ˆæ ‡é¢˜
        if (data.title) {
          html += `<h1 class="plan-title">${escapeHtml(data.title)}</h1>`;
        }

        // éå†æ‰€æœ‰ç« èŠ‚
        if (data.sections && Array.isArray(data.sections)) {
          data.sections.forEach(section => {
            // ç« èŠ‚æ ‡é¢˜
            html += `<h2 class="section-title">${escapeHtml(section.title)}</h2>`;

            // å¦‚æœæ˜¯é¡¹ç›®ç« èŠ‚ï¼ˆå››ã€é¡¹ç›®è®¾ç½®ä¸è§„åˆ™ï¼‰
            if (section.projects && Array.isArray(section.projects)) {
              section.projects.forEach((project, index) => {
                html += `<div class="project-card">`;
                html += `<h3 class="project-name">é¡¹ç›®${index + 1}ï¼š${escapeHtml(project.name)}</h3>`;

                if (project.details && Array.isArray(project.details)) {
                  html += `<ul class="project-details">`;
                  project.details.forEach(detail => {
                    html += `<li>${escapeHtml(detail)}</li>`;
                  });
                  html += `</ul>`;
                }

                if (project.image && project.image !== 'null') {
                  html += `<div class="project-image-container">`;
                  html += `<img src="${escapeHtml(project.image)}" alt="${escapeHtml(project.name)}" class="project-image" />`;
                  html += `</div>`;
                }

                html += `</div>`;
              });
            }
            // å¦‚æœæ˜¯æ™®é€šç« èŠ‚ï¼ˆæœ‰subsectionsï¼‰
            else if (section.subsections && Array.isArray(section.subsections)) {
              section.subsections.forEach(subsection => {
                html += `<div class="subsection">`;
                html += `<h3 class="subsection-title">${escapeHtml(subsection.subtitle)}</h3>`;

                // å¦‚æœæœ‰è¡¨æ ¼
                if (subsection.table) {
                  html += `<table class="plan-table">`;
                  html += `<thead><tr>`;
                  subsection.table.headers.forEach(header => {
                    html += `<th>${escapeHtml(header)}</th>`;
                  });
                  html += `</tr></thead>`;
                  html += `<tbody>`;
                  subsection.table.rows.forEach(row => {
                    html += `<tr>`;
                    row.forEach(cell => {
                      html += `<td>${escapeHtml(cell)}</td>`;
                    });
                    html += `</tr>`;
                  });
                  html += `</tbody></table>`;
                }
                // å¦‚æœæœ‰åˆ—è¡¨
                else if (subsection.list && Array.isArray(subsection.list)) {
                  html += `<ul class="subsection-list">`;
                  subsection.list.forEach(item => {
                    html += `<li>${escapeHtml(item)}</li>`;
                  });
                  html += `</ul>`;
                }
                // å¦‚æœæœ‰æ–‡æœ¬å†…å®¹
                else if (subsection.content) {
                  html += `<p class="subsection-content">${escapeHtml(subsection.content)}</p>`;
                }

                html += `</div>`;
              });
            }
          });
        }

        return html;
      } catch (e) {
        console.error('JSONæ¸²æŸ“å¤±è´¥:', e);
        return `<div class="hint">JSONæ¸²æŸ“å¤±è´¥ï¼š${escapeHtml(e.message)}</div>`;
      }
    }

    function addMsg(role, text, isMarkdown = (role === 'assistant')) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'assistant' ? 'assistant' : 'user');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = isMarkdown ? renderMarkdown(text) : (text || '').replace(/\n/g, '<br/>');

      // ä¸ºæ‰€æœ‰å›¾ç‰‡æ·»åŠ åŠ è½½é”™è¯¯å¤„ç†
      if (isMarkdown) {
        const images = bubble.querySelectorAll('img');
        images.forEach(img => {
          img.onerror = function() {
            this.style.display = 'none';
            const placeholder = document.createElement('div');
            placeholder.className = 'img-placeholder';
            placeholder.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
            this.parentNode.insertBefore(placeholder, this.nextSibling);
          };
        });
      }

      wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // åˆå§‹ç³»ç»Ÿæç¤ºï¼ˆåªåœ¨æ²¡æœ‰æ¢å¤å¯¹è¯æ—¶æ˜¾ç¤ºï¼‰
    if (!chatRestored) {
      addMsg('assistant', 'æ‚¨å¥½ï¼æˆ‘æ˜¯AIå¤‡è¯¾åŠ©ç† ğŸ“\n\næˆ‘å¯ä»¥å¸®æ‚¨ç”Ÿæˆï¼š\n- **è¯¾è¯¾ç»ƒæ–¹æ¡ˆ**ï¼šæ—¥å¸¸ä½“è‚²è¯¾è®­ç»ƒè®¡åˆ’\n- **å…¨å‘˜è¿åŠ¨ä¼šæ–¹æ¡ˆ**ï¼šå­¦æ ¡è¿åŠ¨ä¼šç»„ç»‡æ–¹æ¡ˆ\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä¼šå¼•å¯¼æ‚¨è¡¥å……å¿…è¦ä¿¡æ¯ã€‚');
    }

    document.getElementById('btnInit').onclick = () => {
      const text = 'ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ èƒ½åšä»€ä¹ˆï¼Ÿ';
      addMsg('user', text);
      handlePlanStream(text);
    };

    document.getElementById('btnDemo1').onclick = () => {
      const text = 'å¸®æˆ‘ç”Ÿæˆä¸€ä»½è¯¾è¯¾ç»ƒæ–¹æ¡ˆï¼Œä¸€å¹´çº§ä¸€ç­ï¼Œçƒç±»è¿åŠ¨ï¼ŒåŒäººé…åˆï¼Œéœ€è¦æå‡é€Ÿåº¦';
      addMsg('user', text);
      handlePlanStream(text);
    };

    document.getElementById('btnDemo2').onclick = () => {
      const text = 'å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªå…¨å‘˜è¿åŠ¨ä¼šæ–¹æ¡ˆï¼Œä¸‰å¹´çº§ï¼Œçƒç±»é¡¹ç›®ï¼Œ100äººå‚åŠ ';
      addMsg('user', text);
      handlePlanStream(text);
    };

    sendBtn.onclick = async () => {
      const text = inputEl.value.trim();
      if (!text) return;
      addMsg('user', text);
      inputEl.value = '';
      await handlePlanStream(text);
    };

    // é”®ç›˜å¿«æ·é”®ï¼šEnterå‘é€ï¼ŒShift+Enteræ¢è¡Œ
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    async function handlePlan(message) {
      try {
        const res = await fetch('/api/teacher/plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
        if (data.need_more_info) {
          const ask = data.ask || 'ä¸ºæ›´å¥½ç”Ÿæˆæ–¹æ¡ˆï¼Œè¯·è¡¥å……ç¼ºå¤±ä¿¡æ¯ã€‚';
          addMsg('assistant', `<div class="hint">${ask}</div><div class="ask small">å·²æ”¶é›†ï¼š<code>${JSON.stringify(data.collected_so_far)}</code></div>`);
          return;
        }
        // ä¼˜å…ˆæ˜¾ç¤ºæ¨¡å‹Markdownæ–¹æ¡ˆ
        if (data.plan_markdown && data.plan_markdown.trim()) {
          addMsg('assistant', data.plan_markdown, true);
        } else {
          // ç»“æ„åŒ–å…œåº•æ–¹æ¡ˆ
          addMsg('assistant', `<div class="hint">æ¨¡å‹æœªè¿”å›æ–¹æ¡ˆï¼Œè¯·é‡è¯•æˆ–è¡¥å……æ›´å¤šå…³é”®ä¿¡æ¯ã€‚</div>`, false);
        }
      } catch (e) {
        addMsg('assistant', `<span class="hint">å¤‡è¯¾ç”Ÿæˆå¤±è´¥ï¼š${e.message}</span>`);
      }
    }

    async function handlePlanStream(message) {
      try {
        const res = await fetch('/api/teacher/plan/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            conversation_history: conversationHistory
          })
        });

        // æ£€æŸ¥Content-Typeå’Œå“åº”å¤´
        const contentType = res.headers.get('content-type') || '';
        const needMoreInfo = res.headers.get('X-Need-More-Info');
        const collectedParams = res.headers.get('X-Collected-Params');
        console.log('å“åº”Content-Type:', contentType, 'çŠ¶æ€:', res.status, 'X-Need-More-Info:', needMoreInfo);

        if (contentType.includes('application/json')) {
          try {
            const data = await res.json();
            console.log('è§£æåˆ°JSONæ•°æ®:', data);
            if (data.need_more_info) {
              const ask = data.ask || 'ä¸ºæ›´å¥½ç”Ÿæˆæ–¹æ¡ˆï¼Œè¯·è¡¥å……ç¼ºå¤±ä¿¡æ¯ã€‚';
              addMsg('assistant', `<div class="hint">${ask}</div><div class="ask small">å·²æ”¶é›†ï¼š<code>${JSON.stringify(data.collected_so_far || {})}</code></div>`, false);
              // æ›´æ–°å¯¹è¯å†å²
              if (data.conversation_history) {
                conversationHistory = data.conversation_history;
              }
              return;
            }
            if (!data.success) {
              addMsg('assistant', `<span class="hint">ç”Ÿæˆå¤±è´¥ï¼š${escapeHtml(data.message || 'æœªçŸ¥é”™è¯¯')}</span>`, false);
              return;
            }
            // å¤„ç†æ— å…³è¾“å…¥æˆ–å…¶ä»–æ¶ˆæ¯
            if (data.message) {
              addMsg('assistant', data.message, true);  // ä½¿ç”¨markdownæ¸²æŸ“
              // æ›´æ–°å¯¹è¯å†å²
              if (data.conversation_history) {
                conversationHistory = data.conversation_history;
              }
              return;
            }
            // å¦‚æœJSONè§£ææˆåŠŸä½†æ²¡æœ‰need_more_infoï¼Œè¯´æ˜å¯èƒ½æ˜¯å…¶ä»–JSONå“åº”ï¼Œä¸åº”è¯¥ç»§ç»­æµå¼å¤„ç†
            console.warn('æ”¶åˆ°JSONå“åº”ä½†æœªå¤„ç†:', data);
            return;
          } catch (jsonErr) {
            // å¦‚æœä¸æ˜¯æœ‰æ•ˆJSONï¼Œç»§ç»­æµå¼å¤„ç†
            console.warn('JSONè§£æå¤±è´¥ï¼Œå°è¯•æµå¼è¯»å–:', jsonErr);
          }
        }

        if (!res.ok) {
          const err = await res.text();
          addMsg('assistant', `<span class="hint">æµå¼ç”Ÿæˆå¤±è´¥ï¼š${escapeHtml(err)}</span>`, false);
          return;
        }

        // é¢„ç½®ä¸€ä¸ªç©ºçš„åŠ©æ‰‹æ°”æ³¡ï¼Œå¢é‡å¡«å……
        const wrap = document.createElement('div');
        wrap.className = 'msg assistant';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = '';
        wrap.appendChild(bubble);
        chatEl.appendChild(wrap);
        chatEl.scrollTop = chatEl.scrollHeight;

        // å¦‚æœå“åº”ä½“å·²è¢«æ¶ˆè´¹ï¼ˆæ¯”å¦‚JSONè§£æï¼‰ï¼Œéœ€è¦é‡æ–°è·å–
        if (res.bodyUsed) {
          addMsg('assistant', `<span class="hint">å“åº”å·²æ¶ˆè´¹ï¼Œæ— æ³•è¯»å–æµ</span>`, false);
          return;
        }

        console.log('å¼€å§‹è¯»å–æµå¼æ•°æ®...');
        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buf = '';
        let chunkCount = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            console.log('æµå¼è¯»å–å®Œæˆï¼Œæ€»chunkæ•°:', chunkCount, 'æ€»é•¿åº¦:', buf.length);
            break;
          }
          chunkCount++;
          const chunk = decoder.decode(value, { stream: true });
          buf += chunk;
          console.log(`æ”¶åˆ°chunk ${chunkCount}, é•¿åº¦: ${chunk.length}, ç´¯è®¡: ${buf.length}`);
          // ç®€å•å¢é‡æ¸²æŸ“ï¼ˆMarkdownï¼‰
          bubble.innerHTML = renderMarkdown(buf);
          chatEl.scrollTop = chatEl.scrollHeight;
        }

        if (buf.length === 0) {
          console.warn('æµå¼æ•°æ®ä¸ºç©ºï¼');
          bubble.innerHTML = '<span class="hint">æœªæ”¶åˆ°ä»»ä½•æ•°æ®ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—</span>';
        } else {
          // æ£€æŸ¥æ˜¯å¦æ˜¯å¼•å¯¼è¯­ï¼ˆéœ€è¦æ›´å¤šä¿¡æ¯ï¼‰
          if (needMoreInfo === '1') {
            console.log('âœ… æ”¶åˆ°å¼•å¯¼è¯­ï¼Œéœ€è¦æ›´å¤šä¿¡æ¯');
            // æ˜¾ç¤ºå¼•å¯¼è¯­å’Œå·²æ”¶é›†çš„å‚æ•°
            let collectedDisplay = '';
            if (collectedParams) {
              try {
                const params = JSON.parse(collectedParams);
                collectedDisplay = `<div class="ask small">å·²æ”¶é›†ï¼š<code>${JSON.stringify(params, null, 2)}</code></div>`;
              } catch (e) {
                console.warn('è§£æX-Collected-Paramså¤±è´¥:', e);
              }
            }
            bubble.innerHTML = `<div class="hint">${renderMarkdown(buf)}</div>${collectedDisplay}`;
          }

          // æˆåŠŸç”Ÿæˆæ–¹æ¡ˆï¼Œæ›´æ–°å¯¹è¯å†å²
          conversationHistory.push({ role: 'user', content: message });
          conversationHistory.push({ role: 'assistant', content: buf });
          // åªä¿ç•™æœ€è¿‘5è½®å¯¹è¯
          if (conversationHistory.length > 10) {
            conversationHistory = conversationHistory.slice(-10);
          }

          // ä¿å­˜å¯¹è¯å†å²å’ŒèŠå¤©ç•Œé¢åˆ°sessionStorageï¼ˆç”¨äºä»ç­çº§ç®¡ç†ç³»ç»Ÿè¿”å›æ—¶æ¢å¤ï¼‰
          sessionStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
          sessionStorage.setItem('chatHTML', chatEl.innerHTML);
        }
      } catch (e) {
        console.error('æµå¼ç”Ÿæˆå¼‚å¸¸:', e);
        addMsg('assistant', `<span class="hint">æµå¼ç”Ÿæˆå¼‚å¸¸ï¼š${e.message}</span>`, false);
      }
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>
</body>
</html>



